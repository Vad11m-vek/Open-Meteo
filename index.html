<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAV Forecast Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #1a3a1c 0%, #2c5f2d 100%);
            color: #fff;
            min-height: 100vh;
        }

        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .location-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
        }

        .location-display:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-refresh {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .model-selector {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .model-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .model-btn {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
        }

        .model-btn.active {
            background: rgba(76, 175, 80, 0.4);
            border-color: #4CAF50;
        }

        .tiles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .tile {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .tile-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .tile-label {
            font-size: 0.75rem;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .tile-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 8px 0;
        }

        .timeline-section {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .timeline-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .timeline-item {
            min-width: 80px;
            text-align: center;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 2px solid transparent;
        }

        .timeline-item.active {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .profile-section {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-box {
            background: #2c5f2d;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 1rem;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .preset-btn {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .btn-apply {
            flex: 1;
            padding: 12px;
            background: #4CAF50;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .tiles-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .model-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="location-display" id="locationBtn">
            <span>üìç</span>
            <span id="locationText">–ö–∏—ó–≤, –£–∫—Ä–∞—ó–Ω–∞</span>
        </div>
        <button class="btn-refresh" id="refreshBtn">üîÑ</button>
    </div>

    <div class="container">
        <div id="loadingDiv" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</p>
        </div>

        <div class="model-selector" id="modelSelectorDiv" style="display: none;">
            <div class="model-buttons" id="modelBtns"></div>
        </div>

        <div class="tiles-grid" id="tilesDiv" style="display: none;"></div>

        <div class="timeline-section" id="timelineDiv" style="display: none;">
            <div class="section-title">–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –≥–æ–¥–∏–Ω–∞—Ö</div>
            <div class="timeline-scroll" id="timelineScroll"></div>
        </div>

        <div class="profile-section" id="profileDiv" style="display: none;">
            <div class="section-title">–ü—Ä–æ—Ñ—ñ–ª—å –≤—ñ—Ç—Ä—É</div>
            <table id="profileTable"></table>
        </div>

        <div class="profile-section" id="compareDiv" style="display: none;">
            <div class="section-title">–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –º–æ–¥–µ–ª–µ–π</div>
            <table id="compareTable"></table>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-box">
            <div class="modal-title">–í–∏–±—ñ—Ä –ª–æ–∫–∞—Ü—ñ—ó</div>
            <div class="input-group">
                <label>–®–∏—Ä–æ—Ç–∞:</label>
                <input type="number" id="latInput" step="0.01" value="50.45">
            </div>
            <div class="input-group">
                <label>–î–æ–≤–≥–æ—Ç–∞:</label>
                <input type="number" id="lonInput" step="0.01" value="30.52">
            </div>
            <div class="input-group">
                <label>–ù–∞–∑–≤–∞:</label>
                <input type="text" id="nameInput" value="–ö–∏—ó–≤, –£–∫—Ä–∞—ó–Ω–∞">
            </div>
            <div class="preset-grid">
                <button class="preset-btn" data-lat="50.45" data-lon="30.52" data-name="–ö–∏—ó–≤">üá∫üá¶ –ö–∏—ó–≤</button>
                <button class="preset-btn" data-lat="46.48" data-lon="30.73" data-name="–û–¥–µ—Å–∞">üá∫üá¶ –û–¥–µ—Å–∞</button>
                <button class="preset-btn" data-lat="49.99" data-lon="36.23" data-name="–•–∞—Ä–∫—ñ–≤">üá∫üá¶ –•–∞—Ä–∫—ñ–≤</button>
                <button class="preset-btn" data-lat="48.46" data-lon="35.05" data-name="–î–Ω—ñ–ø—Ä–æ">üá∫üá¶ –î–Ω—ñ–ø—Ä–æ</button>
            </div>
            <div class="modal-actions">
                <button class="btn-apply" id="applyBtn">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
                <button class="btn-cancel" id="cancelBtn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
        const STATE = {
            lat: 50.45,
            lon: 30.52,
            name: '–ö–∏—ó–≤, –£–∫—Ä–∞—ó–Ω–∞',
            currentModel: 'gfs',
            data: {}
        };

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            setupEventListeners();
            loadAllData();
        }

        function setupEventListeners() {
            document.getElementById('locationBtn').addEventListener('click', openModal);
            document.getElementById('refreshBtn').addEventListener('click', loadAllData);
            document.getElementById('applyBtn').addEventListener('click', applyNewLocation);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);

            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('latInput').value = btn.dataset.lat;
                    document.getElementById('lonInput').value = btn.dataset.lon;
                    document.getElementById('nameInput').value = btn.dataset.name + ', –£–∫—Ä–∞—ó–Ω–∞';
                });
            });
        }

        async function loadAllData() {
            showLoading(true);

            try {
                const [gfs, icon, ecmwf, windy] = await Promise.all([
                    fetchOM('best_match'),
                    fetchOM('icon_global'),
                    fetchOM('ecmwf_ifs025'),
                    fetchWindy()
                ]);

                STATE.data = { gfs, icon, ecmwf, windy };
                console.log('Data loaded:', STATE.data);

                renderAll();
                showSections();
            } catch (error) {
                console.error('Error:', error);
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function fetchOM(model) {
            const url = `https://api.open-meteo.com/v1/forecast?` +
                `latitude=${STATE.lat}&longitude=${STATE.lon}` +
                `&models=${model}` +
                `&hourly=windspeed_10m,windspeed_80m,windspeed_120m,windspeed_180m` +
                `,winddirection_10m,winddirection_80m,winddirection_120m,winddirection_180m` +
                `,windgusts_10m,temperature_2m,temperature_80m,temperature_120m,temperature_180m` +
                `,relativehumidity_2m,cloudcover,visibility,precipitation,weathercode` +
                `&timezone=auto&forecast_days=2`;

            const res = await fetch(url);
            if (!res.ok) throw new Error(`Open-Meteo ${model} failed`);
            return await res.json();
        }

        async function fetchWindy() {
            const res = await fetch('https://api.windy.com/api/point-forecast/v2', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    lat: STATE.lat,
                    lon: STATE.lon,
                    model: "gfs",
                    parameters: ["wind", "temp"],
                    levels: ["surface", "950h", "900h", "850h", "800h", "700h", "600h", "500h"],
                    key: "8LSlMIu1xWAVn4ePmrgxIMyzvg9VBC6G"
                })
            });
            if (!res.ok) throw new Error('Windy failed');
            return await res.json();
        }

        function renderAll() {
            renderModelButtons();
            renderTiles();
            renderTimeline();
            renderProfile();
            renderComparison();
        }

        function renderModelButtons() {
            const models = [
                { id: 'gfs', name: 'GFS', desc: 'NOAA' },
                { id: 'icon', name: 'ICON', desc: 'DWD' },
                { id: 'ecmwf', name: 'ECMWF', desc: '–ù–∞–π—Ç–æ—á–Ω—ñ—à–∏–π' },
                { id: 'windy', name: 'Windy', desc: '8 –≤–∏—Å–æ—Ç' }
            ];

            document.getElementById('modelBtns').innerHTML = models.map(m => `
                <button class="model-btn ${m.id === STATE.currentModel ? 'active' : ''}" 
                        onclick="changeModel('${m.id}')">
                    ${m.name}<br><small>${m.desc}</small>
                </button>
            `).join('');
        }

        function changeModel(model) {
            STATE.currentModel = model;
            renderAll();
        }

        function renderTiles() {
            const model = STATE.currentModel;
            const data = STATE.data[model];
            if (!data) return;

            if (model === 'windy') {
                const wind = calcWind(data['wind_u-surface'][0], data['wind_v-surface'][0]);
                const temp = data['temp-surface'][0] - 273.15;
                document.getElementById('tilesDiv').innerHTML = `
                    <div class="tile">
                        <div class="tile-icon">üí®</div>
                        <div class="tile-label">–í—ñ—Ç–µ—Ä</div>
                        <div class="tile-value">${Math.round(wind.speed)} –∫–º/–≥–æ–¥</div>
                    </div>
                    <div class="tile">
                        <div class="tile-icon">üå°Ô∏è</div>
                        <div class="tile-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
                        <div class="tile-value">${Math.round(temp)}¬∞C</div>
                    </div>
                `;
            } else {
                const h = data.hourly;
                const now = findNow(data);
                document.getElementById('tilesDiv').innerHTML = `
                    <div class="tile">
                        <div class="tile-icon">üí®</div>
                        <div class="tile-label">–í—ñ—Ç–µ—Ä</div>
                        <div class="tile-value">${Math.round(h.windspeed_10m[now])} –∫–º/–≥–æ–¥</div>
                    </div>
                    <div class="tile">
                        <div class="tile-icon">üå™Ô∏è</div>
                        <div class="tile-label">–ü–æ—Ä–∏–≤–∏</div>
                        <div class="tile-value">${Math.round(h.windgusts_10m[now])} –∫–º/–≥–æ–¥</div>
                    </div>
                    <div class="tile">
                        <div class="tile-icon">üå°Ô∏è</div>
                        <div class="tile-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
                        <div class="tile-value">${Math.round(h.temperature_2m[now])}¬∞C</div>
                    </div>
                    <div class="tile">
                        <div class="tile-icon">üíß</div>
                        <div class="tile-label">–í–æ–ª–æ–≥—ñ—Å—Ç—å</div>
                        <div class="tile-value">${h.relativehumidity_2m[now]}%</div>
                    </div>
                    <div class="tile">
                        <div class="tile-icon">‚òÅÔ∏è</div>
                        <div class="tile-label">–•–º–∞—Ä–Ω—ñ—Å—Ç—å</div>
                        <div class="tile-value">${h.cloudcover[now]}%</div>
                    </div>
                    <div class="tile">
                        <div class="tile-icon">üëÅÔ∏è</div>
                        <div class="tile-label">–í–∏–¥–∏–º—ñ—Å—Ç—å</div>
                        <div class="tile-value">${Math.round(h.visibility[now]/1000)} –∫–º</div>
                    </div>
                `;
            }
        }

        function renderTimeline() {
            const model = STATE.currentModel;
            if (model === 'windy') return;

            const data = STATE.data[model];
            if (!data) return;

            const h = data.hourly;
            const html = h.time.slice(0, 24).map((t, i) => {
                const hour = new Date(t).getHours().toString().padStart(2, '0');
                const wind = Math.round(h.windspeed_10m[i]);
                return `
                    <div class="timeline-item ${i === 0 ? 'active' : ''}">
                        <div>${hour}:00</div>
                        <div style="font-size: 1.2rem; margin: 8px 0;">‚òÄÔ∏è</div>
                        <div>${wind} –∫–º/–≥–æ–¥</div>
                    </div>
                `;
            }).join('');

            document.getElementById('timelineScroll').innerHTML = html;
        }

        function renderProfile() {
            const model = STATE.currentModel;
            let html = '<thead><tr><th>–í–∏—Å–æ—Ç–∞</th><th>–®–≤–∏–¥–∫—ñ—Å—Ç—å</th><th>–ü–æ—Ä–∏–≤–∏</th><th>–ù–∞–ø—Ä—è–º–æ–∫</th><th>–¢–µ–º–ø.</th></tr></thead><tbody>';

            if (model === 'windy') {
                const wd = STATE.data.windy;
                const levels = {
                    'surface': '10–º', '950h': '500–º', '900h': '1000–º', '850h': '1500–º',
                    '800h': '2000–º', '700h': '3000–º', '600h': '4200–º', '500h': '5500–º'
                };

                Object.entries(levels).forEach(([lvl, height]) => {
                    const wind = calcWind(wd[`wind_u-${lvl}`][0], wd[`wind_v-${lvl}`][0]);
                    const temp = wd[`temp-${lvl}`][0] - 273.15;
                    html += `
                        <tr>
                            <td><strong>${height}</strong> <span style="font-size: 0.7rem; opacity: 0.7;">Windy</span></td>
                            <td>${Math.round(wind.speed)} –∫–º/–≥–æ–¥</td>
                            <td>-</td>
                            <td>${Math.round(wind.direction)}¬∞ (${getDir(wind.direction)})</td>
                            <td>${Math.round(temp)}¬∞C</td>
                        </tr>
                    `;
                });
            } else {
                const data = STATE.data[model];
                const h = data.hourly;
                const now = findNow(data);

                [
                    { ht: '10–º', s: h.windspeed_10m[now], g: h.windgusts_10m[now], d: h.winddirection_10m[now], t: h.temperature_2m[now] },
                    { ht: '80–º', s: h.windspeed_80m[now], g: '-', d: h.winddirection_80m[now], t: h.temperature_80m[now] },
                    { ht: '120–º', s: h.windspeed_120m[now], g: '-', d: h.winddirection_120m[now], t: h.temperature_120m[now] },
                    { ht: '180–º', s: h.windspeed_180m[now], g: '-', d: h.winddirection_180m[now], t: h.temperature_180m[now] }
                ].forEach(l => {
                    html += `
                        <tr>
                            <td><strong>${l.ht}</strong> <span style="font-size: 0.7rem; opacity: 0.7;">${model.toUpperCase()}</span></td>
                            <td>${Math.round(l.s)} –∫–º/–≥–æ–¥</td>
                            <td>${typeof l.g === 'number' ? Math.round(l.g) + ' –∫–º/–≥–æ–¥' : l.g}</td>
                            <td>${Math.round(l.d)}¬∞ (${getDir(l.d)})</td>
                            <td>${Math.round(l.t)}¬∞C</td>
                        </tr>
                    `;
                });
            }

            html += '</tbody>';
            document.getElementById('profileTable').innerHTML = html;
        }

        function renderComparison() {
            let html = '<thead><tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>GFS</th><th>ICON</th><th>ECMWF</th><th>Windy</th></tr></thead><tbody>';

            ['–í—ñ—Ç–µ—Ä 10–º', '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞'].forEach(param => {
                html += `<tr><td><strong>${param}</strong></td>`;

                ['gfs', 'icon', 'ecmwf'].forEach(m => {
                    const d = STATE.data[m];
                    if (d) {
                        const now = findNow(d);
                        const val = param === '–í—ñ—Ç–µ—Ä 10–º' 
                            ? `${Math.round(d.hourly.windspeed_10m[now])} –∫–º/–≥–æ–¥`
                            : `${Math.round(d.hourly.temperature_2m[now])}¬∞C`;
                        html += `<td>${val}</td>`;
                    } else {
                        html += '<td>-</td>';
                    }
                });

                const wd = STATE.data.windy;
                if (wd) {
                    const val = param === '–í—ñ—Ç–µ—Ä 10–º'
                        ? `${Math.round(calcWind(wd['wind_u-surface'][0], wd['wind_v-surface'][0]).speed)} –∫–º/–≥–æ–¥`
                        : `${Math.round(wd['temp-surface'][0] - 273.15)}¬∞C`;
                    html += `<td>${val}</td>`;
                } else {
                    html += '<td>-</td>';
                }

                html += '</tr>';
            });

            html += '</tbody>';
            document.getElementById('compareTable').innerHTML = html;
        }

        function calcWind(u, v) {
            const speed = Math.sqrt(u * u + v * v) * 3.6;
            const direction = (Math.atan2(-u, -v) * 180 / Math.PI + 360) % 360;
            return { speed, direction };
        }

        function getDir(deg) {
            const dirs = ['–ü–Ω', '–ü–Ω–°—Ö', '–°—Ö', '–ü–¥–°—Ö', '–ü–¥', '–ü–¥–ó—Ö', '–ó—Ö', '–ü–Ω–ó—Ö'];
            return dirs[Math.round(deg / 45) % 8];
        }

        function findNow(data) {
            const now = new Date().getHours();
            return data.hourly.time.findIndex(t => new Date(t).getHours() === now) || 0;
        }

        function showLoading(show) {
            document.getElementById('loadingDiv').style.display = show ? 'block' : 'none';
        }

        function showSections() {
            document.getElementById('modelSelectorDiv').style.display = 'block';
            document.getElementById('tilesDiv').style.display = 'grid';
            document.getElementById('timelineDiv').style.display = 'block';
            document.getElementById('profileDiv').style.display = 'block';
            document.getElementById('compareDiv').style.display = 'block';
        }

        function openModal() {
            document.getElementById('modalOverlay').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
        }

        function applyNewLocation() {
            STATE.lat = parseFloat(document.getElementById('latInput').value);
            STATE.lon = parseFloat(document.getElementById('lonInput').value);
            STATE.name = document.getElementById('nameInput').value;
            document.getElementById('locationText').textContent = STATE.name;
            closeModal();
            loadAllData();
        }
    </script>
</body>
</html>
